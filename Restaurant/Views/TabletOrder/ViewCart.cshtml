@model List<Restaurant.Models.ViewModels.CartItemViewModel>
@{
    ViewData["Title"] = "Tablet Cart";
    var grandTotal = Model.Sum(item => item.Price * item.Quantity);
}

<style>
    body {
        padding-top: 70px
    }</style>

<h2 class="text-center text-success fw-bold">Your Cart</h2>

@if (!Model.Any())
{
    <div class="alert alert-success text-center">Your cart is empty.</div>
}
else
{
    <table class="table table-bordered border-success">
        <thead class="table-success">
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            @foreach (var item in Model)
            {
                <tr data-item-id="@item.ItemId">
                    <td>@item.Name</td>
                    <td>@item.Price.ToString("C")</td>
                    <td class="qty">@item.Quantity</td>
                    <td class="sub">@((item.Price * item.Quantity).ToString("C"))</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="adj(@item.ItemId,-1)">-</button>
                        <button class="btn btn-sm btn-success" onclick="adj(@item.ItemId,1)">+</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="del(@item.ItemId)">Remove</button>
                    </td>
                </tr>
            }
            <tr class="table-light">
                <td colspan="3" class="text-end fw-bold">Total:</td>
                <td colspan="2" id="grand" class="fw-bold text-success">@grandTotal.ToString("C")</td>
            </tr>
        </tbody>
    </table>

    <div class="text-center mt-4">
        <form asp-action="PlaceOrder" asp-controller="TabletOrder" method="post">
            @Html.AntiForgeryToken()
            <div class="mb-3">
                <label class="form-label fw-bold text-success">Select Table:</label>
                <select name="tableNumber" class="form-select border-success" required>
                    <option value="">-- Select --</option>
                    @for (int i = 1; i <= 20; i++)
                    {
                        <option value="@i">Table @i</option>
                    }
                </select>
            </div>
            <button type="submit" class="btn btn-success btn-lg">Place Order</button>
        </form>
    </div>
}

@section Scripts
{
    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        async function post(url, body) {
            await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: new URLSearchParams(body)
            });
            location.reload(); // simplest refresh (or use JS to update totals)
        }

        function adj(id, d) {
            post(`/TabletOrder/${d > 0 ? 'IncreaseQuantity' : 'DecreaseQuantity'}`, { itemId: id });
        }

        function del(id) {
            post('/TabletOrder/RemoveFromCart', { itemId: id });
        }
    </script>
}